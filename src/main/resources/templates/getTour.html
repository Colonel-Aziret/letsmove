<!DOCTYPE html>
<html lang="en" xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <!-- Include necessary libraries only once -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>


    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">

</head>
<body>

<!-- Your HTML content here -->


<div class="navbar-fixed">
    <nav style="background-color: #09181F;">
        <div class="container">
            <div class="nav-wrapper">


                <a href="#" data-target="mobile-demo" class="sidenav-trigger"><i
                        class="material-icons white-text">menu</i></a>
                <ul class="right hide-on-med-and-down">
                    <li>
                        <a href="/get_all_attraction" class="white-text">Достопримечательности</a>
                    </li>
                    <li>
                        <a href="/get_all_place" class="white-text">Заведения</a>
                    </li>
                    <li>
                        <a href="/get_all_tour" class="white-text">Туры</a>
                    </li>
                    <li>
                        <a href="/add_place" class="white-text">Новое место</a>
                    </li>
                    <li>
                        <a href="/check_place" class="white-text">Проверка мест</a>

                    </li>

                    <li>
                        <a class="white-text" href="/check_tour">Проверка туров</a>
                    </li>
                    <li>
                        <a class="white-text" href="/get_all_author_place">Мои места</a>
                    </li>
                    </li>
                    <li>
                        <a href="/get_all_tour" class="white-text">Туры</a>
                    </li>
                    <li sec:authorize="isAnonymous()"><a href="/login" class="white-text">Мой профиль</a>
                    </li>
                    <li sec:authorize="hasAuthority('ADMIN')"><a href="/adminMain" class="white-text">Мой
                        профиль</a></li>
                    <li sec:authorize="hasAuthority('MANAGER')"><a href="/managerMain" class="white-text">Мой
                        профиль</a></li>
                    <li sec:authorize="hasAuthority('GUIDE')"><a href="/guideMain" class="white-text">Мой
                        профиль</a></li>
                    <li sec:authorize="hasAuthority('USER')"><a href="/userMain" class="white-text">Мой
                        профиль</a></li>


                </ul>
            </div>
        </div>
    </nav>
</div>

<ul class="sidenav" id="mobile-demo">
    <li>
        <a href="#home">Новое место</a>
    </li>
    <li>
        <a href="#search">Search</a>
    </li>
    <li>
        <a href="#popular">Popular Places</a>
    </li>
    <li>
        <a href="#gallery">Gallery</a>
    </li>
    <li>
        <a href="#contact">Contact</a>
    </li>
</ul>
<div class="container">
    <div class="row">

        <div class="product-container">
            <div class="container">
                <div class="product-container">
                    <div class="product-card">
                        <div class="card-thumbnail">
                            <img class="img-responsive" th:src="${tour.getImg()}">
                        </div>
                        <div class="card-content">

                            <h1 th:text="${tour.getNameTour()}" class="card-title">

                            </h1>
                            <h2 th:text="${tour.getGuidesID().getFio()}" class="card-sub-title">

                            </h2>
                            <p th:text="${tour.getInfo()}" class="description">

                            </p>
                            <p th:text="${tour.getGuidesID().getPhoneNumber()}"></p>
                            <ul class="list-inline post-meta">
                                <li class="card-comment">
                                    <a class="modal-trigger"> <i th:id="${tour.getId()}"
                                                                 class="fa fa-comments"></i></a>

                                    <form th:action="@{/getTour}" method="post">
                                        <input th:value="${tour.getId()}" type="number" hidden="hidden" name="tourId"/>

                                        <td>
                                            <input style="margin-bottom: 30px" type="submit" class="btn btn-outline-success" value="Забронировать тур"/>
                                        </td>
                                    </form>


                                </li>

                            </ul>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <div th:id="'commentModal-' + ${tour.getId()}" style="width: 68%" class="modal">
            <div class="modal-content" data-place-id=""
                 style="height: 80vh; overflow-y: auto;">
                <!-- Заголовок модального окна -->
                <h4>Комментарии</h4>

                <!-- Список комментариев -->

                <ul id="commentList" class="collection">

                </ul>


                <!-- Форма для добавления комментариев -->

                <form th:action="@{/save_tour_comment}" method="POST">
                    <input type="hidden" name="tourId" th:value="${tour.getId()}">

                    <div class="input-field">
                        <input type="text" name="commentText" placeholder="Введите ваш комментарий">
                    </div>
                    <button type="submit" class="waves-effect waves-light btn">Добавить комментарий</button>
                </form>


            </div>
            <div class="modal-footer">
                <a href="#!" class="modal-close waves-effect waves-green btn">Закрыть</a>

            </div>
        </div>

    </div>
</div>
</div>
</body>
</html>
<script>
    // JavaScript код


    var jq = jQuery.noConflict();
    const buttons = document.querySelectorAll('.modal-trigger');

    jq('.star').on('click', function () {
        const selectedRating = jq(this).data('rating'); // Получаем значение рейтинга из атрибута data-rating
        jq('#ratingInput').val(selectedRating); // Обновляем значение скрытого поля

        const count = jq(this).attr('name');
        jq('.star').removeClass('selected'); // Удаляем класс 'selected' у всех звезд
        for (let i = 0; i < count; i++) {
            jq('.star').eq(i).addClass('selected'); // Добавляем класс 'selected' только выбранным звездам
        }
    });


    buttons.forEach(btn => {
        btn.addEventListener('click', function (e) {
            const placeId = e.target.id; // Получите id места из кнопки
            const modalId = `#commentModal-${placeId}`; // Сгенерируйте id модального окна
            jq(modalId).modal('open'); // Откройте соответствующее модальное окно
            fetchComments(placeId); // Вызовите функцию для получения комментариев
        });
    });
    jq(document).ready(function () {
        // Инициализация всех модальных окон при загрузке страницы
        jq('.modal').modal();
    })

    async function fetchComments(placeId) {
        try {
            const response = await axios.get('/get_comments_tour/' + placeId);

            if (response.status >= 200 && response.status < 300) {
                const comments = response.data;
                console.log(response.data)

                const commentList = document.getElementById("commentList");
                commentList.innerHTML = "";

                comments.forEach(comment => {
                    const li = document.createElement("li");
                    li.className = "collection-item";

                    const usernameSpan = document.createElement("span");
                    usernameSpan.className = "comment-username";
                    usernameSpan.innerText = comment.usersID.login;
                    console.log(usernameSpan)
                    const dateSpan = document.createElement("span");
                    dateSpan.className = "comment-date";
                    const formattedTime = formatTimeAgo(comment.createdDate);
                    dateSpan.innerText = formattedTime;

                    const textParagraph = document.createElement("p");
                    textParagraph.className = "comment-text";
                    textParagraph.innerText = comment.comment;

                    li.appendChild(usernameSpan);
                    li.appendChild(dateSpan);
                    li.appendChild(textParagraph);

                    commentList.appendChild(li);
                });
            }
        } catch (error) {
            console.error("Error fetching comments:", error);
            alert("Error fetching comments. Check the console for details.");
        }
    }


    jq(function () {
        jq('.product-card').hover(function () {
            jq(this).find('.description').animate({
                height: "toggle",
                opacity: "toggle"
            }, 300);
        });
    });

    function formatTimeAgo(timestamp) {
        const currentDate = new Date();
        const targetDate = new Date(timestamp);

        const timeDifference = currentDate - targetDate;
        const seconds = Math.floor(timeDifference / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        if (days > 0) {
            return days === 1 ? 'вчера' : `${days} дня назад`;
        } else if (hours > 0) {
            return hours === 1 ? 'час назад' : `${hours} часов назад`;
        } else if (minutes > 0) {
            return minutes === 1 ? 'минуту назад' : `${minutes} минут назад`;
        } else {
            return seconds < 5 ? 'только что' : `${seconds} секунд назад`;
        }
    }


</script>
<style>
    /* Стили для звезд */
    .rating {
        unicode-bidi: bidi-override;
        direction: rtl;
        text-align: center;
    }

    .rating > span {
        display: inline-block;
        position: relative;
        font-size: 30px; /* Размер звезд */
        margin: 0 5px; /* Расстояние между звездами */
    }

    .rating > span:hover,
    .rating > span:hover ~ span {
        color: transparent;
    }

    .rating > span:hover:before,
    .rating > span:hover ~ span:before {
        content: "\2605"; /* Звездочка */
        position: absolute;
        left: 0;
        color: gold;
    }

    .selected {
        color: gold;
    }

    /* Стили для кнопки "Отправить" */
    .submit-button {
        background-color: #007BFF; /* Цвет фона кнопки */
        color: white; /* Цвет текста кнопки */
        border: none;
        padding: 10px 20px;
        font-size: 16px;
        border-radius: 5px;
        cursor: pointer;
    }

    .submit-button:hover {
        background-color: #0056b3; /* Измененный цвет фона при наведении */
    }

    body {
        background-image: url('https://sap.quickbase.com/up/biv7kj2ug/g/rh/eh/va/canvas-ptrn.jpg');
    }

    .wrapper {
        background-color: #55A0EF;
        height: 175px;
        width: 100%;
        opacity: 0.7;
        box-shadow: 0px 2px 3px #000;
        left: 0px;
        right: 0px;
        position: absolute;
    }


    .collection {
        max-height: 300px; /* Установите желаемую максимальную высоту */
        overflow-y: auto; /* Добавьте вертикальный скролл при необходимости */
    }


    .comment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .comment-username {
        font-weight: bold;
        margin-right: 19px;
        color: #3498db; /* Цвет имени пользователя */
    }

    .comment-date {
        color: #212529;;
        margin-left: auto; /* Цвет даты создания */
    }

    .comment-text {
        margin-top: 10px;
        color: #333; /* Цвет текста комментария */
    }

    html,
    body {
        background-color: #f4f4ef;
    }

    a,
    a:hover,
    a:active {
        text-decoration: none;
        color: #525c65;
        transition: color 0.3s ease;
    }

    .product-container {
        width: 80%; /* Задайте желаемую ширину контейнера */
        max-width: 800px; /* Максимальная ширина контейнера, если необходимо */
        margin: 0 auto; /* Автоматически центрировать контейнер по горизонтали */
        padding: 20px; /* Добавьте отступы по вашему усмотрению */
    }


    .product-card {
        position: relative;
        margin: 10px 0px;
        z-index: 1;
        display: block;
        background: #FFFFFF;
        min-width: 270px;
        height: 470px;
        box-shadow: 12px 15px 20px 0px rgba(46, 61, 73, 0.15);
        border-radius: 0.375rem;
        transition: all 0.3s ease;

    }

    .product-card {
        width: 100%;
    }


    .product-card:hover {
        box-shadow: 2px 4px 8px 0px rgba(46, 61, 73, 0.2)
    }

    .product-card {
        width: 500px;
        height: 700px /* Пример фиксированной ширины */
    }

    .product-card .card-thumbnail {
        background: #000000;
        /* height: 400px; */
        overflow: hidden;
    }

    .product-card .card-thumbnail img {
        display: block;
        width: 120%;
        -webkit-transition: all .3s cubic-bezier(0, .5, .5, 1);
        -o-transition: all .3s cubic-bezier(0, .5, .5, 1);
        transition: all .3s cubic-bezier(0, .5, .5, 1);
    }

    .product-card:hover .card-thumbnail img {
        -webkit-transform: scale(1.1);
        -moz-transform: scale(1.1);
        transform: scale(1.1);
        opacity: .6;
    }

    .fa-send:before {
        color: #fff;
        position: absolute;
        top: 15px;
        left: 13px;
    }

    .product-card .card-content {
        position: absolute;
        bottom: 0;
        background: #FFFFFF;
        width: 100%;
        padding: 40px 30px;
        -webkti-box-sizing: border-box;
        -moz-box-sizing: border-box;
        box-sizing: border-box;
        -webkit-transition: all 0.3s cubic-bezier(0.37, 0.75, 0.61, 1.05) 0s;
        -moz-transition: all 0.3s cubic-bezier(0.37, 0.75, 0.61, 1.05) 0s;
        -ms-transition: all 0.3s cubic-bezier(0.37, 0.75, 0.61, 1.05) 0s;
        -o-transition: all 0.3s cubic-bezier(0.37, 0.75, 0.61, 1.05) 0s;
        transition: all 0.3s cubic-bezier(0.37, 0.75, 0.61, 1.05) 0s;
    }

    .product-card .card-content .send {
        position: absolute;
        top: -30px;
        right: 10px;
        height: 60px;
        width: 60px;
        background: #197;
        border-radius: 50%;
        cursor: pointer;
        transition: all 1s ease;
        transition-delay: 0.3s;
        opacity: 0;
    }

    .product-card:hover .card-content .send {
        opacity: 1;
    }

    .product-card .card-content .card-title {
        margin: 0;
        padding: 0 0 10px;
        color: #333333;
        font-size: 20px;
        font-weight: 700;
        text-transform: capitalize;
    }

    .product-card .card-content .card-sub-title {
        margin: 0;
        padding: 0 0 20px;
        color: #197;
        font-size: 15px;
        font-weight: 400;
        text-transform: capitalize;
    }

    .product-card .card-content .description {
        color: #666666;
        font-size: 12px;
        line-height: 1.8em;
        display: none;
        /* height: 0px; */
    }

    .product-card .card-content .post-meta {
        margin: 30px 0 0;
        color: #999999;
    }

    .product-card .card-content .post-meta .time-stamp {
        margin: 0 80px 0 0;
    }

    .product-card .card-content .post-meta a {
        color: inherit;
        text-decoration: none;
    }
</style>